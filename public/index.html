<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ethos-style Agent Wallet</title>
    <style>
      :root {
        --bg: #f7f8fb;
        --panel: #ffffff;
        --text: #13161c;
        --muted: #5d6c7b;
        --line: #e8ecf2;
        --accent: #0082f3;
        --good: #16a34a;
        --warn: #d97706;
        --bad: #dc2626;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .container { max-width: 1180px; margin: 0 auto; padding: 28px 18px 48px; }
      .topbar {
        display: flex; justify-content: space-between; align-items: center;
        gap: 12px; margin-bottom: 20px;
      }
      h1 { margin: 0; font-size: 32px; letter-spacing: -0.02em; }
      .sub { margin: 6px 0 0; color: var(--muted); }
      .pill {
        border: 1px solid var(--line); background: #fff; border-radius: 999px;
        padding: 7px 12px; font-size: 12px; color: var(--muted);
      }

      .stats { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 14px; }
      @media (min-width: 900px) { .stats { grid-template-columns: repeat(4, minmax(0, 1fr)); } }

      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
      }
      .stat .k { font-size: 11px; text-transform: uppercase; color: var(--muted); letter-spacing: .04em; }
      .stat .v { margin-top: 6px; font-size: 15px; font-weight: 600; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

      .layout { display: grid; grid-template-columns: 1fr; gap: 14px; }
      @media (min-width: 1020px) { .layout { grid-template-columns: 1.1fr .9fr; } }

      .section-title { margin: 0 0 10px; font-size: 16px; }
      .muted { color: var(--muted); font-size: 13px; line-height: 1.45; }
      .row { display: flex; flex-wrap: wrap; gap: 8px; }
      .mt { margin-top: 10px; }

      input, button {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
        color: var(--text);
        padding: 10px 12px;
        font-size: 14px;
      }
      input { min-width: 120px; }
      input:focus { outline: none; border-color: #bcdffb; box-shadow: 0 0 0 3px #0082f31a; }
      button { cursor: pointer; font-weight: 600; }
      button:hover { background: #f2f6fb; }
      .primary { background: var(--accent); color: #fff; border-color: var(--accent); }
      .primary:hover { background: #0072d6; }
      .good { color: var(--good); border-color: #ccebd7; background: #f4fcf6; }
      .warn { color: var(--warn); border-color: #f4dfbf; background: #fffaf2; }
      .danger { color: var(--bad); border-color: #f2c8c8; background: #fff5f5; }

      .timeline .entry { border: 1px solid var(--line); border-radius: 12px; padding: 11px; margin-bottom: 9px; }
      .badge { font-size: 11px; font-weight: 700; border-radius: 999px; padding: 4px 8px; border: 1px solid; }
      .approve { color: #166534; background: #f0fdf4; border-color: #bbf7d0; }
      .reject { color: #991b1b; background: #fef2f2; border-color: #fecaca; }
      .escalate { color: #92400e; background: #fffbeb; border-color: #fde68a; }
      code { color: #0f4c81; background: #f2f6fb; padding: 2px 5px; border-radius: 6px; }
      .dot { width: 10px; height: 10px; border-radius: 50%; background: #9aa4b2; display: inline-block; margin-right: 6px; }
      .dot.live { background: var(--good); }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div>
          <h1>Two-Brain Wallet</h1>
          <p class="sub">Reputation-style trust UX · Solana Devnet agent execution</p>
        </div>
        <div class="pill">DEVNET</div>
      </div>

      <div class="stats">
        <div class="card stat"><div class="k">Wallet</div><div id="sWallet" class="v mono">-</div></div>
        <div class="card stat"><div class="k">SOL Balance</div><div id="sSol" class="v">-</div></div>
        <div class="card stat"><div class="k">Agent Loop</div><div class="v"><span id="liveDot" class="dot"></span><span id="loopText">idle</span></div></div>
        <div class="card stat"><div class="k">Last Run</div><div id="sLast" class="v">-</div></div>
      </div>

      <div class="layout">
        <div>
          <div class="card">
            <h3 class="section-title">Wallet & dApp Proof</h3>
            <div class="row">
              <button class="primary" onclick="createWallet()">Create Wallet</button>
              <button onclick="refreshWallet()">Refresh Wallet</button>
              <button class="good" onclick="sendMemo()">Send Memo Proof</button>
            </div>
            <p id="wallet" class="muted mt">Loading wallet…</p>
          </div>

          <div class="card mt">
            <h3 class="section-title">Manual Command</h3>
            <p class="muted">Use format: <code>SWAP 0.1 SOL TO USDC SLIPPAGE 30</code></p>
            <div class="row">
              <input id="cmd" style="flex:1" value="SWAP 0.1 SOL TO USDC SLIPPAGE 30" />
              <button class="primary" onclick="sendCommand()">Run Debate</button>
              <button onclick="refreshEvents()">Refresh</button>
            </div>
          </div>

          <div class="card mt">
            <h3 class="section-title">Autonomous Agent Loop</h3>
            <div class="row">
              <input id="agentCmd" style="flex:1" value="SWAP 0.05 SOL TO USDC SLIPPAGE 30" />
              <input id="intervalSec" type="number" min="10" value="60" style="width:100px" />
            </div>
            <div class="row mt">
              <button class="good" onclick="startAgent()">Start</button>
              <button class="warn" onclick="tickAgent()">Run Tick</button>
              <button class="danger" onclick="stopAgent()">Stop</button>
            </div>
            <p id="agentStatus" class="muted mt">Loading status…</p>
          </div>
        </div>

        <div>
          <div class="card timeline">
            <h3 class="section-title">Debate Timeline</h3>
            <div id="events"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function jsonFetch(url, opts = {}) {
        const headers = { 'content-type': 'application/json', ...(opts.headers || {}) };
        const res = await fetch(url, { ...opts, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'request failed');
        return data;
      }

      const fmtTime = (iso) => (iso ? new Date(iso).toLocaleTimeString() : '-');

      async function createWallet() {
        const out = await jsonFetch('/wallet/create', { method: 'POST' });
        await refreshWallet();
        alert(`Wallet created: ${out.publicKey}`);
      }

      async function refreshWallet() {
        try {
          const w = await jsonFetch('/wallet');
          document.getElementById('wallet').innerText = `Address: ${w.publicKey}\nSOL: ${w.sol}\nRPC: ${w.rpcUrl}`;
          document.getElementById('sWallet').innerText = `${w.publicKey.slice(0, 6)}...${w.publicKey.slice(-6)}`;
          document.getElementById('sSol').innerText = String(w.sol);
        } catch (e) {
          document.getElementById('wallet').innerText = e.message;
        }
      }

      async function sendMemo() {
        const memo = `ui-proof-${Date.now()}`;
        try {
          const out = await jsonFetch('/dapp/memo', { method: 'POST', body: JSON.stringify({ memo }) });
          alert(`Memo sent: ${out.signature}`);
          await refreshWallet();
        } catch (e) {
          alert(e.message);
        }
      }

      async function sendCommand() {
        try {
          const text = document.getElementById('cmd').value;
          await jsonFetch('/command', { method: 'POST', body: JSON.stringify({ text }) });
          await refreshEvents();
        } catch (e) {
          alert(e.message);
        }
      }

      async function act(url, payload) {
        try {
          await jsonFetch(url, { method: 'POST', body: JSON.stringify(payload) });
          await refreshEvents();
        } catch (e) {
          alert(e.message);
        }
      }

      async function tickAgent() {
        try {
          const command = document.getElementById('agentCmd').value;
          await jsonFetch('/agent/tick', { method: 'POST', body: JSON.stringify({ command }) });
          await refreshAll();
        } catch (e) {
          alert(e.message);
        }
      }

      async function startAgent() {
        try {
          const command = document.getElementById('agentCmd').value;
          const intervalSec = Number(document.getElementById('intervalSec').value || 60);
          await jsonFetch('/agent/start', { method: 'POST', body: JSON.stringify({ command, intervalSec }) });
          await refreshAgentStatus();
        } catch (e) {
          alert(e.message);
        }
      }

      async function stopAgent() {
        try {
          await jsonFetch('/agent/stop', { method: 'POST', body: '{}' });
          await refreshAgentStatus();
        } catch (e) {
          alert(e.message);
        }
      }

      async function refreshAgentStatus() {
        const s = await jsonFetch('/agent/status');
        document.getElementById('agentStatus').innerText = `running=${s.running} intervalSec=${s.intervalSec} command="${s.command}"\nlastRunAt=${s.lastRunAt || '-'}\nlastError=${s.lastError || '-'}`;
        document.getElementById('liveDot').className = `dot ${s.running ? 'live' : ''}`;
        document.getElementById('loopText').innerText = s.running ? 'running' : 'idle';
        document.getElementById('sLast').innerText = fmtTime(s.lastRunAt);
      }

      function decisionBadge(decision) {
        const c = decision === 'APPROVE' ? 'approve' : decision === 'REJECT' ? 'reject' : 'escalate';
        return `<span class="badge ${c}">${decision}</span>`;
      }

      async function refreshEvents() {
        const data = await jsonFetch('/events');
        const root = document.getElementById('events');
        root.innerHTML = '';
        for (const d of data.debates) {
          const el = document.createElement('div');
          el.className = 'entry';
          el.innerHTML = `
            <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:6px">
              <div><strong>${d.intent.inputSymbol}→${d.intent.outputSymbol}</strong> <span class="muted">${d.intent.amount} ${d.intent.amountUnit}</span></div>
              ${decisionBadge(d.decision)}
            </div>
            <div class="muted">${new Date(d.createdAt).toLocaleString()}</div>
            <div class="muted mt">${d.alphaReasoning}</div>
            <div class="muted">${d.guardReasoning}</div>
            <div class="muted mono mt">TX: ${d.executionTx || '-'}</div>
            <div class="row mt">
              <button onclick="act('/override',{debateId:'${d.id}',approved:true})">Override Approve</button>
              <button onclick="act('/override',{debateId:'${d.id}',approved:false})">Override Reject</button>
              <button class="primary" onclick="act('/execute',{debateId:'${d.id}'})">Execute</button>
            </div>
          `;
          root.appendChild(el);
        }
      }

      async function refreshAll() {
        await Promise.all([refreshWallet(), refreshAgentStatus(), refreshEvents()]);
      }

      refreshAll();
      setInterval(refreshAgentStatus, 8000);
      setInterval(refreshEvents, 12000);
    </script>
  </body>
</html>
